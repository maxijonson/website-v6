import BlogHomeBanner from "$/image/blog/blog-home-banner.jpg";
import { getLatestPosts } from "../../../sanity/queries/post/getLatestPosts";
import { getCategories } from "../../../sanity/queries/categories/getCategories";
import BlogHero from "./components/blog-hero/blog-hero";
import BlogSection from "./components/blog-section/blog-section";
import Footer from "@/components/footer/footer";
import BlogHeader from "./components/blog-header/blog-header";
import { getLatestPostsByCategoryId } from "../../../sanity/queries/post/getLatestPostsByCategoryId";

const BlogPage = async () => {
  const [latestPosts, categories] = await Promise.all([
    getLatestPosts(),
    getCategories(),
  ]);

  const latestPostsByCategory = (
    await Promise.all(
      categories.map(async (category) => {
        const posts = await getLatestPostsByCategoryId(category.id);
        return {
          category,
          posts: posts.filter((post) =>
            latestPosts.every((latestPost) => latestPost.id !== post.id),
          ),
        };
      }),
    )
  ).filter(({ posts }) => posts.length > 0);

  return (
    <>
      <BlogHeader />
      <main className="min-h-dvh">
        <BlogHero
          banner={BlogHomeBanner}
          bannerAlt="Blog Home Banner (Generated by Gemini)"
          title="Exploring the tech stack"
          description="Check out some of the blog posts I've written about tech and programming!"
          breadcrumbs={[{ label: "Blog", href: "/blog" }]}
          categories={categories.map((category) => ({
            label: category.name,
            href: `/blog/${category.slug}`,
          }))}
        />

        <div className="flex flex-col gap-4">
          <BlogSection
            title="Latest Posts"
            posts={latestPosts}
            variant="featured"
          />
          {latestPostsByCategory.map(({ category, posts }) => (
            <BlogSection
              key={category.id}
              title={category.name}
              posts={posts}
              url={`/blog/${category.slug}`}
            />
          ))}
        </div>
      </main>
      <Footer />
    </>
  );
};

export default BlogPage;
